{% extends "core/base.html" %}
 {% load category_service %}
{% load adv_diff %}
{% block content %}
 {% get_category_service %} 
 {% include "service/includes/modal/suborder_peple.html" %}
 {% include "service/includes/modal/add_contract_new.html" %}
  {% include "service/includes/modal/subcontract.html" %} 
  {% include "service/includes/modal/operation.html" %}
  {% include "service/includes/modal/operation_out.html" %}

<input type="hidden" id="page_name" value="{{ title }}" />
<button
          class="open-modal btn_month_bill"
          data-name="modal-add-bill"
          data-cat-service="{{ title }}">
          +
        </button>

<section class="bill-month">
{% for bill in bills %}
  <div class="bill_month_one-wrap">
    
      {% ifchanged %}
      <h3 class="bill_month-title">{{ now|date:"F Y" }}</h3>
      <div class="bill-month_category-title">
        <div class="bill-month-client-counter"></div>
        <div class="bill_w-120"><h3>Клиент</h3></div>
        <div class="bill_w-120"><h3>Договор</h3></div>
        <div class="bill_w-120">
          <h3>Счёт</h3>
          <button
            class="open-modal btn_month_bill"
            data-name="modal-add-bill"
            data-month="0"
            data-cat-service="{{ title }}"
          >
            +
          </button>
        </div>
        <div class="bill_w-120"><h3>Ведение</h3></div>
        <div class="bill_w-120 suborder_title-bg"><h3>Субподряд</h3></div>
        
        {% for suborder_name in suborders_name %}
        
        <div class="bill_w-120 suborder_title-bg "><h4> {{suborder_name.name}}</h4></div>
        
        {% endfor %}
        
        <div class="bill_w-120 suborder_title-bg">
          
        <h4>Премии</h4></div> 
        <div class="bill_w-120 bill_oretation-add_title margin_left"><h3>Приход</h3></div>
  
        <div class="bill_w-120 bill_oretation-add_title"><h4>ООО</h4></div>
        <div class="bill_w-120 bill_oretation-add_title"><h4>ИП</h4></div>
        <div class="bill_w-120 bill_oretation-add_title"><h4>$</h4></div>
  
        <div class="bill_w-120 bill_oretation-exit_title margin_left"><h3>Расход</h3></div>
        <div class="bill_w-120 bill_oretation-exit_title"><h4>ООО</h4></div>
        <div class="bill_w-120 bill_oretation-exit_title"><h4>ИП</h4></div>
        <div class="bill_w-120 bill_oretation-exit_title"><h4>$</h4></div>
      </div>
      {% endifchanged %}

      <div class="bill-month_item-wrapper">
        <div class="bill-month-client-counter">{{ forloop.counter }}</div>
        <div class="bill-month-client-name bill_w-120">
          {{ bill.client.client_name }}
        </div>
        
        <div class="bill-month-client-contract bill_w-120">
          {{ bill.contract_number }}
        </div>
        <div class="bill-month-client-sum bill_w-120">
          {{ bill.contract_sum }} ₽
        </div>
        <div class="bill-month-client-adv_sum bill_w-120">
          {{ bill.adv_all_sum }} ₽
          
        </div>
 

     
   
         <div class="suborder-bg">
        <div
          class="bill-month-client-suborder_diff bill_w-120 add_sabcontactor {% if bill.chekin_add_subcontr == 0 %} red {% endif %}"
          data-name="modal-add-subcontract"
        
          data-bill-month-id="{{ bill.id }}" data-bill-month-client-name="{{ bill.client.client_name }}"
          
          data-bill-month-adv="{{bill.diff_sum}}"
          
          data-bill-month-name="{{ bill.contract_number }}"
          data-bill-month-data="{{ created_timestamp|date:"M Y" }}"
          data-bill-sb="{{ bill.subcontractmonth }}"
          
        >
      
      {{ bill.diff_sum }} ₽
        </div>

        {% if title == 1 %}
         {% for sub_adv in bill.suborders_adv %}
          {% if bill.chekin_add_subcontr %}
            {% if sub_adv.name_adv != 0 %}
               
              {% if sub_adv.amount_subs != 0 %}
              <div class="bill_w-120"> 
                <div class="suborder_out_operation"
                data-sub-type="1"
                data-name="modal-suborder_out_operation"
                data-bill-month-id="{{ bill.id }}"
                data-bill-month-adv="{{ bill.diff_sum}}"
                data-bill-month-client-name="{{ bill.client.client_name }}"
                data-bill-month-name="{{ bill.contract_number }}"
                data-bill-month-data="{{ created_timestamp|date:"M Y" }}"
                data-name-sub=" {{ sub_adv.name_adv }}"
                data-id-sub="{{ sub_adv.id_subs }}"
                data-id-sub-amount="{{ sub_adv.amount_subs }}" 
                > 
                {{sub_adv.amount_subs}} ₽
                </div>
            </div>
              {% else %}<div class="bill_w-120"> 0 ₽</div>
              {% endif %}

              

              {% else %}
              
            {% endif %}
            {% else %}
            <div class="bill_w-120 red"> n/a</div>
          {% endif %}
        {% endfor %} 
        {% for sub_other in bill.suborders_other %}
       
        {% if sub_other.total_amount != 0 %}
        {% if forloop.last %}
        
        

         <div class="bill_w-120"> 
          <div class="suborder_out_operation_people"
          data-sub-type="2"
          data-name="modal-suborder_out_operation_people"
          data-bill-month-id="{{ bill.id }}"
          data-bill-month-adv="{{ bill.diff_sum}}"
          data-bill-month-client-name="{{ bill.client.client_name }}"
          data-bill-month-name="{{ bill.contract_number }}"
          data-bill-month-data="{{ bill.created_timestamp|date:"M Y" }}"
          data-name-sub="Премии"
          data-id-sub=" {{sub_other.id_subs}}"
          data-id-sub-amount=" {{sub_other.total_amount}} " 
          > 
          {{sub_other.total_amount}}  ₽
          </div>
      </div>
        {% endif %}
      
     
         {% else %}
         <div class="bill_w-120 {% if bill.chekin_add_subcontr == 0 %} red {% endif %}"> 0 ₽</div>
        {% endif %}
       
   
        {% empty %}
       
        {% endfor %}
       
        {% endif %}
      </div> 
      

       {% for oper_entry in  bill.get_operation %}
        {% ifchanged %}
      <div class="oretation-add-bg"> 
        <div
          class=" add-operation-entry"
          data-name="modal-add-operation-entry"
          data-bill-month-id="{{ bill.id }}"
          data-bill-month-sum="{{ bill.contract_sum }} "
          data-bill-month-client-name="{{ bill.client.client_name }}"
          data-bill-month-sum-dont-operation="{{ bill.contract_sum }} "
          data-bill-month-name="{{ bill.contract_number }}"
          data-bill-month-operation-entry="
        {{oper_entry.id_operation_entry}}
          "
        >
        {% if oper_entry.operation_entry_all == bill.contract_sum %}
        <p class="result_ok">{{ bill.contract_sum }} ₽</p>
      
      
       {% elif oper_entry.diff_operation_entry > 0 %}
        <div class="result_not-wrap"><p class="result_not">{{oper_entry.operation_entry_all}}₽
          <p class="result_not_after">/долг {{oper_entry.diff_operation_entry }}₽</p>
        </p>  </div>
        {% else %} 
        <div class="result_not-wrap"><p class="result_not">0 ₽
          <p class="result_not_after">/долг {{ bill.contract_sum }}₽</p>
        </p>  </div>
        {% endif %} 
        </div> 
        
        <div class="bill_w-120 operation_entry_bank ">
          <p class="operation_entry_bank_true">
            {% if oper_entry.operation_entry_bank1 %}
              {{oper_entry.operation_entry_bank1 }}₽
              {% else %} 0 ₽
            {% endif %} 
          </p>
        </div>

          <div class="bill_w-120 operation_entry_bank" >
            <p class="operation_entry_bank_true">
              {% if oper_entry.operation_entry_bank2 %}
              {{oper_entry.operation_entry_bank2 }}₽
              {% else %} 0 ₽
            {% endif %}
            </p>
          </div> 

          <div class="bill_w-120 operation_entry_bank">
            <p class="operation_entry_bank_true">
              {% if oper_entry.operation_entry_bank3 %}
              {{oper_entry.operation_entry_bank3 }}₽
              {% else %} 0 ₽
            {% endif %}
            </p>
          </div> 
         
         </div>


         <div class="oretation-out-bg bill_oretation-exit_title"> 
      
       
          <div
            class="add-operation-out"
            
          >
       
  
          {% if oper_entry.operation_out_all == bill.diff_sum %}
          <p class="result_ok">{{ bill.diff_sum }} ₽</p>
        
        
         {% elif oper_entry.diff_operation_out > 0 %}
          <div class="result_not-wrap"><p class="result_not">{{oper_entry.operation_out_all}}₽
            <p class="result_not_after">/остаток {{oper_entry.diff_operation_out}}₽</p>
          </p>  </div>
          {% else %} 
          <div class="result_not-wrap">
            <p class="result_not">0 ₽
            <p class="result_not_after">/остаток {{ bill.diff_sum }}₽</p>
          </p>  </div>
          {% endif %} 
          </div> 
          
          <div class="bill_w-120 operation_entry_bank ">
            <p class="operation_entry_bank_true">
              {% if bill.chekin_add_subcontr %}
                {% if oper_entry.operation_out_bank1 %}
                  {{oper_entry.operation_out_bank1 }}₽
                  {% else %} 0 ₽
                {% endif %} 
              {% else %}
              n/a
              {% endif %}

              
            </p>
          </div>
  
            <div class="bill_w-120 operation_entry_bank" >
              <p class="operation_entry_bank_true">
                {% if bill.chekin_add_subcontr %}
                  {% if oper_entry.operation_out_bank2 %}
                    {{oper_entry.operation_out_bank2 }}₽
                  {% else %} 0 ₽
                  {% endif %}
                {% else %}
                n/a
                {% endif %}
               
              </p>
            </div> 
  
            <div class="bill_w-120 operation_entry_bank">
              <p class="operation_entry_bank_true">
                {% if bill.chekin_add_subcontr %} 
                  {% if oper_entry.operation_out_bank3 %}
                  {{oper_entry.operation_out_bank3 }}₽
                  {% else %} 0 ₽
                  {% endif %}
                {% else %}
                n/a
                {% endif %}
               
              </p>
            </div> 
           
           </div>
        
      

  
       {% endifchanged %}{% endfor %}
    </div> 
    
    


    
    </div>
    {% comment %} <div class="result_not-wrap">
      <p class="result_not">0 ₽
      <p class="result_not_after">/остаток {{ bill.diff_sum }}₽</p>
    </p>  </div> {% endcomment %}
{% if forloop.last %}
<div class="bill-month_category-title bill-month_category-ended">
  <div class="bill-month-client-counter"></div>
  <div class="bill_w-120"><h3>Итого</h3></div>
  <div class="bill_w-120"><h3></h3></div>
  <div class="bill_w-120">
    <h3>{{total_month_contract_sum}} ₽</h3>
   
  </div>
  <div class="bill_w-120"><h3>{{total_month_adv_all_sum}} ₽</h3></div>
  <div class="bill_w-120 suborder_title-bg"><h3>{{total_month_diff_sum}} ₽</h3></div>

  {% for total_adv in obj_suborder_adv %}
  <div class="bill_w-120 suborder_title-bg"><h3>{{total_adv.total_amount}} ₽</h3></div>
  {% endfor %}


 <div class="bill_w-120 suborder_title-bg"><h3>{{suborder_total_other.total_amount}} ₽</h3></div>

  {% comment %} <div class="bill_w-120 suborder_title-bg"><h4>Премии</h4></div>  {% endcomment %}
  {% for total_operat in total_oper %}
  {% if total_operat.total_diff_operation_entry == 0 %}
  <div class="bill_w-120 bill_oretation-add_title margin_left"><h3>{{total_operat.total_sum_all_operation_entry}}  ₽</h3> </div>
  {% else %}
  <div class="bill_w-120 bill_oretation-add_title margin_left not_check">
    <h3 class="result_not">{{total_operat.total_sum_all_operation_entry}} ₽
    <p class="result_not_after">/долг {{ total_operat.total_diff_operation_entry }} ₽</p>
  </h3>  </div>
  {% endif %}
 

  <div class="bill_w-120 bill_oretation-add_title"><h4>{{total_operat.total_sum_operation_entry_bank1}}  ₽</h4></div>
  <div class="bill_w-120 bill_oretation-add_title"><h4>{{total_operat.total_sum_operation_entry_bank2}}  ₽</h4></div>
  <div class="bill_w-120 bill_oretation-add_title"><h4>{{total_operat.total_sum_operation_entry_bank3}}  ₽</h4></div>

  {% if total_operat.total_diff_operation_out == 0 %}
  <div class="bill_w-120 bill_oretation-add_title margin_left"><h3>{{total_operat.total_sum_all_operation_out}}  ₽</h3> </div>
  {% else %}
  <div class="bill_w-120 bill_oretation-add_title margin_left not_check">
    <h3 class="result_not">{{total_operat.total_sum_all_operation_out}} ₽
    <p class="result_not_after">/остаток {{ total_operat.total_diff_operation_out }} ₽</p>
  </h3>  </div>
  {% endif %}

  <div class="bill_w-120 bill_oretation-exit_title"><h4>{{total_operat.total_sum_operation_out_bank1}}  ₽</h4></div>
  <div class="bill_w-120 bill_oretation-exit_title"><h4>{{total_operat.total_sum_operation_out_bank2}}  ₽</h4></div>
  <div class="bill_w-120 bill_oretation-exit_title"><h4>{{total_operat.total_sum_operation_out_bank3}}  ₽</h4></div>
  
  {% endfor %} 
 
</div>
{% endif %}

    
    
    
    {% endfor %}
  
   

</section>


































{% endblock content %}





{% comment %} {% regroup ordered_bill by created_timestamp|date:"M Y" as ordered_bill_list %}
  <div class="bill_month_one-wrap">
    {% for created_timestamp in ordered_bill_list %}
    <h3 class="bill_month-title">{{ created_timestamp.grouper }}</h3>

    <div class="bill-month_category-title">
      <div class="bill-month-client-counter"></div>
      <div class="bill_w-120"><h3>Клиент</h3></div>
      <div class="bill_w-120"><h3>Договор</h3></div>
      <div class="bill_w-120">
        <h3>Счёт</h3>
        <button
          class="open-modal btn_month_bill"
          data-name="modal-add-bill"
          data-month="0"
        >
          +
        </button>
      </div>
      <div class="bill_w-120"><h3>Ведение</h3></div>
      <div class="bill_w-120 suborder_title-bg"><h3>Субподряд</h3></div>

      <div class="bill_w-120 suborder_title-bg "><h4> Директ</h4></div>
      <div class="bill_w-120 suborder_title-bg"><h4>Таргет</h4></div>
      <div class="bill_w-120 suborder_title-bg"><h4>Премии</h4></div>
      <div class="bill_w-120 bill_oretation-add_title margin_left"><h3>Приход</h3></div>

      <div class="bill_w-120 bill_oretation-add_title"><h4>ООО</h4></div>
      <div class="bill_w-120 bill_oretation-add_title"><h4>ИП</h4></div>
      <div class="bill_w-120 bill_oretation-add_title"><h4>$</h4></div>

      <div class="bill_w-120 bill_oretation-exit_title margin_left"><h3>Расход</h3></div>
      <div class="bill_w-120 bill_oretation-exit_title"><h4>ООО</h4></div>
      <div class="bill_w-120 bill_oretation-exit_title"><h4>ИП</h4></div>
      <div class="bill_w-120 bill_oretation-exit_title"><h4>$</h4></div>
    </div>

    {% for bill in created_timestamp.list %}
    <div class="bill-month_item-wrapper">
      <div class="bill-month-client-counter">{{ forloop.counter }}</div>
      <div class="bill-month-client-name bill_w-120">
        {{ bill.client.client_name }}
      </div>
      
      <div class="bill-month-client-contract bill_w-120">
        {{ bill.additional_contract.contract_number }}
      </div>
      <div class="bill-month-client-sum bill_w-120">
        {{ bill.additional_contract.contract_sum }} ₽
      </div>
      <div class="bill-month-client-adv_sum bill_w-120">
        {{ bill.additional_contract.adv_all_sum }} ₽
        
      </div>
    <div class="suborder-bg">
        <div
          class="bill-month-client-suborder_diff bill_w-120 add_sabcontactor"
          data-name="modal-add-subcontract"
         
          data-bill-month-id="{{ bill.id }}" data-bill-month-client-name="{{ bill.client.client_name }}"
          
          data-bill-month-adv="diff_adv_sum"
          
          data-bill-month-name="{{ bill.additional_contract.contract_number }}"
          data-bill-month-data="{{ created_timestamp.grouper }}"
          data-bill-sb="{{ bill.subcontractmonth }}"
          
        >
      
       {{ bill.additional_contract.diff_sum }} ₽
        </div>

        {% if title == 1 %}
      {% for plan in bill.get_sum_planning_adv %}
          
            {% if plan.adv == 1 %}
            <div class="bill_w-120"> 
              <div class="suborder_out_operation"
              data-sub-type="1"
              data-name="modal-suborder_out_operation"
              data-bill-month-id="{{ bill.id }}"
              data-bill-month-adv="diff_adv_sum "
              data-bill-month-client-name="{{ bill.client.client_name }}"
              data-bill-month-name="{{ bill.additional_contract.contract_number }}"
              data-bill-month-data="{{ created_timestamp.grouper }}"
              data-name-sub=" {{ plan.adv }}"
              data-id-sub="{{ plan.id }}"
              data-id-sub-amount="{{ plan.sum }}" 
              > 
              {{ plan.sum }} ₽
              </div>
           </div>
            {% endif %}

           {% if plan.adv == 2  %} 
           <div class="bill_w-120"> 
            <div class="suborder_out_operation"
            data-sub-type="1"
            data-name="modal-suborder_out_operation"
            data-bill-month-id="{{ bill.id }}"
            data-bill-month-adv="diff_adv_sum "
            data-bill-month-client-name="{{ bill.client.client_name }}"
            data-bill-month-name="{{ bill.additional_contract.contract_number }}"
            data-bill-month-data="{{ created_timestamp.grouper }}"
            data-name-sub=" {{plan.adv}}"
            data-id-sub="{{plan.id}}"
            data-id-sub-amount="{{plan.sum}}" 
            > 
            {{plan.sum}} ₽
            </div>
         </div>
            {% endif %} 

            {% if plan.adv == 0  %} 
            <div class="bill_w-120"> 
              
              0 ₽
           </div>
            {% endif %} 


          {% empty %}
          <div class="bill_w-120"> 
            n/a {{plan.id}}
         </div>
         <div class="bill_w-120"> 
          n/a 
       </div>
          {% endfor %}  

      <div class="bill_w-120">
         
          {{bill.sum_other_subcontr.amount__sum|default_if_none:"0"}} ₽ 
         
        </div> 

        {% endif %}
      </div> 
    <div class="oretation-add-bg">
      <div
        class=" add-operation-entry"
        data-name="modal-add-operation-entry"
        data-bill-month-id="{{ bill.id }}"
        data-bill-month-sum="{{ bill.additional_contract.contract_sum }} "
        data-bill-month-client-name="{{ bill.client.client_name }}"
        data-bill-month-sum-dont-operation="{{ bill.additional_contract.contract_sum }} "
        data-bill-month-name="{{ bill.additional_contract.contract_number }}"
        data-bill-month-operation-entry="
        {% for operation_entry in bill.operationentry_set.all %} 
        
        -{{ operation_entry.id }}-
        
        {% endfor %}
        "
      >

    
      {% if bill.get_all_sum_entry_operation == bill.additional_contract.contract_sum %}
      <p class="result_ok">{{ bill.additional_contract.contract_sum }} ₽</p>
    
      
      {% elif bill.get_all_sum_entry_operation.result > 0 %}
      <div class="result_not-wrap"><p class="result_not">{{bill.get_all_sum_entry_operation.operation_amount}}₽
        <p class="result_not_after">/долг {{bill.get_all_sum_entry_operation.result}}₽</p>
      </p>  </div>
      {% else %}
      <div class="result_not-wrap"><p class="result_not">0 ₽
        <p class="result_not_after">/долг {{ bill.additional_contract.contract_sum }}₽</p>
      </p>  </div>
      {% endif %} 
      </div>
      
      <div class="bill_w-120 operation_entry_bank ">
        <p class="operation_entry_bank_true">
          {% for oper_entry_bank1 in bill.get_sum_bank_operaton_entry_bank_one %}           
            {{oper_entry_bank1.total_amount}} ₽
            {% empty %}
            0 ₽
            {% endfor %}
        </p>
      </div>

        <div class="bill_w-120 operation_entry_bank" >
          <p class="operation_entry_bank_true">
            {% for oper_entry_bank2 in bill.get_sum_bank_operaton_entry_bank_two %}           
              {{oper_entry_bank2.total_amount}} ₽
              {% empty %}
              0 ₽
              {% endfor %}
          </p>
        </div> 

        <div class="bill_w-120 operation_entry_bank">
          <p class="operation_entry_bank_true">
            {% for oper_entry_bank3 in bill.get_sum_bank_operaton_entry_bank_three %}           
              {{oper_entry_bank3.total_amount}} ₽
              {% empty %}
              0 ₽
              {% endfor %}
          </p>
        </div> 
        
    </div>   

    <div class="oretation-out-bg bill_oretation-exit_title">

       <div class=" add-operation-out">
       
          {% if bill.diff_subcontr_out_operation.diff_sum == 0%} 
        <p class="result_ok">{{bill.diff_subcontr_out_operation.all_sum_adv}} ₽</p>
         {% else %}
         <div class="result_not-wrap"><p class="result_not">
           {{bill.diff_subcontr_out_operation.all_operation_sum_out}} ₽
           <p class="result_not_after">/остаток {{bill.diff_subcontr_out_operation.diff_sum}} ₽</p>
        </p>  </div> 
         {% endif %}
    
        </div>  
  
        
        {% for operation_out in bill.get_sum_bank_operaton_out_bank %}
        {% if operation_out.bank == 1 %}
        <div class="add-operation-out">
          <p  class="operation_entry_bank_true">
           {{operation_out.sum}} ₽
         
             </p>
        </div>
        {% endif %}
        {% if operation_out.bank == 2 %}
        <div class="add-operation-out">
          <p  class="operation_entry_bank_true">
           {{operation_out.sum}} ₽
         
             </p>
        </div>
        {% endif %}
        {% if operation_out.bank == 3 %}
        <div class="add-operation-out">
          <p  class="operation_entry_bank_true">
           {{operation_out.sum}} ₽
         
             </p>
        </div>
        {% endif %}
        {% if operation_out.bank == 0 %}
        <div class="add-operation-out">
          <p  class="operation_entry_bank_true">
           0 ₽
         
             </p>
        </div>
        {% endif %}
        
        
        
        {% endfor %}
     

      </div> 
    </div>

    {% endfor %}

    

    <div class="bill-month_result">
      <div class="bill-month-client-counter"></div>
      <div class="bill_w-120"><h3>Итого</h3></div>
      <div class="bill_w-120"><h3></h3></div>
      <div class="bill_w-120">
        <h3> {% for income in total_income %} 
          {% if income.month|date:"M Y" == created_timestamp.grouper %} {{ income.total_amount }} 
          {% endif %} 
        {% endfor %} ₽</h3>
     
      </div>
      <div class="bill_w-120"><h3>{% for income_adv in total_adv %} {% if income_adv.month|date:"M Y" == created_timestamp.grouper %} 
        {{ income_adv.total_amount }} 
        {% endif %}
        {% endfor %} ₽</h3>
      </div>

      <div class="bill_w-120 suborder_title-bg">
    
  

      </div>

      <div class="bill_w-120 suborder_title-bg "><h4> Директ</h4></div>
      <div class="bill_w-120 suborder_title-bg"><h4>Таргет</h4></div>
      <div class="bill_w-120 suborder_title-bg"><h4>Премии</h4></div>
      <div class="bill_w-120 bill_oretation-add_title margin_left"><h3>Приход</h3></div>

      <div class="bill_w-120 bill_oretation-add_title"><h4>ООО</h4></div>
      <div class="bill_w-120 bill_oretation-add_title"><h4>ИП</h4></div>
      <div class="bill_w-120 bill_oretation-add_title"><h4>$</h4></div>

      <div class="bill_w-120 bill_oretation-exit_title margin_left"><h3>Расход</h3></div>
      <div class="bill_w-120 bill_oretation-exit_title"><h4>ООО</h4></div>
      <div class="bill_w-120 bill_oretation-exit_title"><h4>ИП</h4></div>
      <div class="bill_w-120 bill_oretation-exit_title"><h4>$</h4></div>
    </div> 
    {% endfor %}
  </div> {% endcomment %}
