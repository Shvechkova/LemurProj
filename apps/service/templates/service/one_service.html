{% extends "core/base.html" %}
 {% load category_service %}
  {% load adv_diff %}
{% block content %}
 {% get_category_service %}
 {% include "service/includes/modal/add_contract_new.html" %}
  {% include "service/includes/modal/subcontract.html" %} 
  {% include "service/includes/modal/operation.html" %}
  {% include "service/includes/modal/operation_out.html" %}

<input type="hidden" id="page_name" value="{{ title }}" />
<section class="bill-month">
  <button
          class="open-modal btn_month_bill"
          data-name="modal-add-bill"
          {% comment %} data-month="{{ created_timestamp.grouper }} " {% endcomment %}
        >
          +
        </button>
  {% comment %} <button
    class="open-modal modal-new_month button_black"
    data-name="modal-new_month"
  >
    Начать новый месяц?не работает
  </button>

  {% now "M Y" %} {{ month_bill_last.created_timestamp|date:"M Y" }}  {% endcomment %}
  {% regroup ordered_bill by created_timestamp|date:"M Y" as ordered_bill_list %}
  <div class="bill_month_one-wrap">
    {% for created_timestamp in ordered_bill_list %}
    <h3 class="bill_month-title">{{ created_timestamp.grouper }}</h3>

    <div class="bill-month_category-title">
      <div class="bill-month-client-counter"></div>
      <div class="bill_w-120"><h3>Клиент</h3></div>
      <div class="bill_w-120"><h3>Договор</h3></div>
      <div class="bill_w-120">
        <h3>Счёт</h3>
        <button
          class="open-modal btn_month_bill"
          data-name="modal-add-bill"
          data-month="{{ created_timestamp.grouper }} "
        >
          +
        </button>
      </div>
      <div class="bill_w-120"><h3>Ведение</h3></div>
      <div class="bill_w-120 suborder_title-bg"><h3>Субподряд</h3></div>
      {% if title == 1 %}
    
      <div class="bill_w-120 suborder_title-bg p_left"><h4> Директ</h4></div>
      <div class="bill_w-120 suborder_title-bg"><h4>Таргет</h4></div>
      <div class="bill_w-120 suborder_title-bg"><h4>Премии</h4></div>
      {% endif %}

      <div class="bill_w-120 bill_oretation-add_title margin_left"><h3>Приход</h3></div>

      <div class="bill_w-120 bill_oretation-add_title"><h4>ООО</h4></div>
      <div class="bill_w-120 bill_oretation-add_title"><h4>ИП</h4></div>
      <div class="bill_w-120 bill_oretation-add_title"><h4>$</h4></div>

      <div class="bill_w-120 bill_oretation-exit_title margin_left"><h3>Расход</h3></div>
      <div class="bill_w-120 bill_oretation-exit_title"><h4>ООО</h4></div>
      <div class="bill_w-120 bill_oretation-exit_title"><h4>ИП</h4></div>
      <div class="bill_w-120 bill_oretation-exit_title"><h4>$</h4></div>
    </div>

    {% for bill in created_timestamp.list %}
    <div class="bill-month_item-wrapper">
      <div class="bill-month-client-counter">{{ forloop.counter }}</div>
      <div class="bill-month-client-name bill_w-120">
        {{ bill.client.client_name }}
      </div>
      <div class="bill-month-client-contract bill_w-120">
        {{ bill.additional_contract.contract_number }}
      </div>
      <div class="bill-month-client-sum bill_w-120">
        {{ bill.additional_contract.contract_sum }} ₽
      </div>
      <div class="bill-month-client-adv_sum bill_w-120">
        {{ bill.additional_contract.adv_all_sum }} ₽
      </div>
      <div class="suborder-bg">
        <div
          class="bill-month-client-suborder_diff bill_w-120 add_sabcontactor"
          data-name="modal-add-subcontract"
          data-bill-month-id="{{ bill.id }}"
          data-bill-month-adv="{% diff_adv_sum all_sum=bill.additional_contract.contract_sum all_adv=bill.additional_contract.adv_all_sum %}"
          data-bill-month-client-name="{{ bill.client.client_name }}"
          data-bill-month-name="{{ bill.additional_contract.contract_number }}"
          data-bill-month-data="{{ created_timestamp.grouper }}"
          data-id-subcontr-adv="
          {% for sbadv in bill.subcontractmonth_set.all %} 
          {% if sbadv.adv %}

           -{{ sbadv.id }}-

          {% endif %}
          {% endfor %}

          "

          data-id-subcontr-other="
          {% for sbadv in bill.subcontractmonth_set.all %} 
          {% if sbadv.other %}

           -{{ sbadv.id }}-

          {% endif %}
          {% endfor %}

          "

        >
        {{bill.diff_sum_adv}} ₽
        </div>

        {% if title == 1 %}
        <div class="bill_w-120">
          {% for subcontr in bill.subcontractmonth_set.all %}
         
         {% if subcontr.adv.id == 1 %} 

         <div class="suborder_out_operation"
         data-sub-type="1"
         data-name="modal-suborder_out_operation"
         data-bill-month-id="{{ bill.id }}"
         data-bill-month-adv="{% diff_adv_sum all_sum=bill.additional_contract.contract_sum all_adv=bill.additional_contract.adv_all_sum %}"
         data-bill-month-client-name="{{ bill.client.client_name }}"
         data-bill-month-name="{{ bill.additional_contract.contract_number }}"
         data-bill-month-data="{{ created_timestamp.grouper }}"
         data-name-sub=" {{subcontr.adv.name}}"
         data-id-sub="{{ subcontr.id }}"
         data-id-sub-amount="{{ subcontr.amount }}" 
        > 
         {{ subcontr.amount }} ₽ 
       </div>
        
         {% endif %}
         {% empty %} 
         n/a
         {% endfor %} 
        </div>
        <div class="bill_w-120  ">
          {% for subcontr in bill.subcontractmonth_set.all %}
         
         {% if subcontr.adv.id == 2 %} 
         <div class="suborder_out_operation p_left"
         data-sub-type="1"
         data-name="modal-suborder_out_operation"
         data-bill-month-id="{{ bill.id }}"
         data-bill-month-adv="{% diff_adv_sum all_sum=bill.additional_contract.contract_sum all_adv=bill.additional_contract.adv_all_sum %}"
         data-bill-month-client-name="{{ bill.client.client_name }}"
         data-bill-month-name="{{ bill.additional_contract.contract_number }}"
         data-bill-month-data="{{ created_timestamp.grouper }}"

         data-name-sub=" {{subcontr.adv.name}}"
         data-id-sub="{{ subcontr.id }}"
         data-id-sub-amount="{{ subcontr.amount }}" 
        > 
         {{ subcontr.amount }} ₽ 
       </div>
        
         {% endif %}
         {% empty %} 
         n/a
         {% endfor %} 
        </div>
        <div class="bill_w-120">
          <div class="suborder_button"
         > 
           {{ subcontr.amount }} ₽ </div>
          {{bill.sum_other_subcontr.amount__sum|default_if_none:"0"}} ₽ 
         
        </div>

        {% endif %}
      </div>
      <div class="oretation-add-bg">
        
        

        <div
          class="bill_w-120 add-operation-entry"
          data-name="modal-add-operation-entry"
          data-bill-month-id="{{ bill.id }}"
          data-bill-month-sum="{{ bill.additional_contract.contract_sum }} "
          data-bill-month-client-name="{{ bill.client.client_name }}"
          data-bill-month-sum-dont-operation="{{ bill.additional_contract.contract_sum }} "
          data-bill-month-name="{{ bill.additional_contract.contract_number }}"
          data-bill-month-operation-entry="
          {% for operation_entry in bill.operationentry_set.all %} 
          
          -{{ operation_entry.id }}-
          
          {% endfor %}
          "
        >

      
        {% if bill.get_all_sum_entry_operation == bill.additional_contract.contract_sum %}
        <p class="result_ok">{{ bill.additional_contract.contract_sum }} ₽</p>
      
        
        {% elif bill.get_all_sum_entry_operation.result > 0 %}
        <div class="result_not-wrap"><p class="result_not">{{bill.get_all_sum_entry_operation.operation_amount}}₽
          <p class="result_not_after">/остаток {{bill.get_all_sum_entry_operation.result}}₽</p>
        </p>  </div>
        {% else %}
        <div class="result_not-wrap"><p class="result_not">0 ₽
          <p class="result_not_after">/остаток {{ bill.additional_contract.contract_sum }}₽</p>
        </p>  </div>
        {% endif %} 
        </div>
       
        <div class="bill_w-120 operation_entry_bank ">
          {% for operations  in bill.get_sum_bank_operaton_entry %}
          {% if operations.bank == 1 %}
          <p  class="operation_entry_bank_true">{{operations.total_amount}} ₽</p>
            {% else %}
           
            {% endif %}
            {% empty %}
            <p  class="operation_entry_bank_true">
                         0 ₽</p>
          {% endfor %}
        </div>

          <div class="bill_w-120 operation_entry_bank" >
            {% for operations  in bill.get_sum_bank_operaton_entry %}
           {% comment %} {{bill.get_sum_bank_operaton_entry|length}} {% endcomment %}
         

           {% if operations.bank == 2  %} 
            
           <p  class="operation_entry_bank_true">{{operations.total_amount}} ₽</p>
           {% else %}
          
           {% endif %}
           {% empty %}
           <p  class="operation_entry_bank_true">
                        0 ₽</p>
          {% endfor %}
          </div> 

          <div class="bill_w-120 operation_entry_bank">
            {% for operations  in bill.get_sum_bank_operaton_entry %}
             {% if operations.bank == 3 %}

            <p  class="operation_entry_bank_true">{{operations.total_amount}} ₽</p>
            {% else %}
           
            {% endif %}
            {% empty %}
            <p  class="operation_entry_bank_true">
                         0 ₽</p>
            {% endfor %}
           
          </div> 
      </div>
      <div class="oretation-out-bg bill_oretation-exit_title">
        
      

        <div class=" add-operation-out">
          {% if bill.sum_real_subcontract == bill.sum_operation_out_subcontract %}
          <p class="result_ok">{{bill.sum_real_subcontract}}₽</p>

          {% elif bill.diff_subcontr_out > 0 %}
          <div class="result_not-wrap"><p class="result_not">
            {{bill.sum_operation_out_subcontract.sum__sum}}₽
            <p class="result_not_after">/остаток 
              {{bill.diff_subcontr_out}}₽</p>
          </p> </div>

          {% else %}
          <div class="result_not-wrap"><p class="result_not">0 ₽
            <p class="result_not_after">/остаток {{ bill.additional_contract.contract_sum }}₽</p>
          </p>  </div> 
          {% endif %} 
        </div>
        <div class="add-operation-out">
          {% for operations  in bill.get_sum_bank_operaton_entry %}
          {% if operations.bank == 1 %}
          <p  class="operation_entry_bank_true">{{operations.total_amount}} ₽</p>
            {% else %}
           
            {% endif %}
            {% empty %}
            <p  class="operation_entry_bank_true">
                         0 ₽</p>
          {% endfor %}
        </div>
       
       
        
      </div>
    </div>
    {% endfor %}
    <div class="bill-month_result_sum">
      <div class="bill-month-client-counter"></div>
      <div class="bill_w-120"><h3>Итого</h3></div>
      <div class="bill_w-120"></div>
      <div class="bill_w-120">
        <h3>
          {% for income in total_income %} 
            {% if income.month|date:"M Y" == created_timestamp.grouper %} {{ income.total_amount }} 
            {% endif %} 
          {% endfor %}
        </h3>
      </div>
      <div class="bill_w-120">
        <h3>
          {% for income_adv in total_adv %} {% if income_adv.month|date:"M Y" == created_timestamp.grouper %} 
          {{ income_adv.total_amount }} 
          {% endif %}
          {% endfor %}
        </h3>
      </div>
      <div class="bill_w-120"><h3>Субподряд</h3></div>
    </div>
    {% endfor %}
  </div>
</section>
{% for d in ordered_bill %} 
  {{ d.created_timestamp }} 
{% endfor %} 

{% endblock content %}
