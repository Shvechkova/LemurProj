{% extends "core/base.html" %}
{% load category_service %}
{% block content %}
  {% get_category_service %}
  {% include "service/includes/modal/suborder_peple.html" %}
  {% include "service/includes/modal/add_contract_new.html" %}
  {% include "service/includes/modal/subcontract.html" %}
  {% include "service/includes/modal/operation.html" %}
  {% include "service/includes/modal/operation_out.html" %}
  <input type="hidden" id="page_name" value="{{ title }}" />
  <div class="open-modal btn_month_bill"
       data-name="modal-add-bill"
       data-cat-service="{{ title }}">+</div>
  <section class="bill-month">
    {% for bill in bills %}
   
      <div class="bill_month_one-wrap">
        {% ifchanged %} <button class="button">копировать месяц</button>
          <h3 class="bill_month-title">{{ now|date:'F Y' }}</h3>
          <div class="bill-month_category-title">
            <div class="bill-month-del"></div>
            <div class="bill-month-client-counter"></div>
            <div class="bill_w-120">
              <h3>Клиент</h3>
            </div>
            <div class="bill_w-120">
              <h3>Договор</h3>
            </div>
            <div class="bill_w-120">
              <h3>Счёт</h3>
              <button class="open-modal btn_month_bill"
                      data-name="modal-add-bill"
                      data-month="0"
                      data-cat-service="{{ title }}">+</button>
            </div>
            {% if title == 1 %}
            <div class="bill_w-120">
              <h3>Ведение</h3>
            </div>
            {% endif %}
            
            <div class="suborder_title-bg">
              <div class="title-bill-120 suborder-bg mr40">
                <h3>Субподряд</h3>
                <div class="open-modal btn_month_bill-shrink"
                     data-name=""
                     data-month="0"
                     data-btn-type-shrink="suborder"
                     data-btn-deg-suborder="180"
                     data-created-btn="{{ bill.created_timestamp|date:'m.Y' }}"
                     data-cat-service="{{ title }}">
                  <svg width="16"
                       height="16"
                       viewBox="0 0 16 16"
                       fill="none"
                       xmlns="http://www.w3.org/2000/svg">
                    <rect x="16.0002" y="16" width="16" height="16" rx="8" transform="rotate(-180 16.0002 16)" fill="black" />
                    <rect x="13.0002" y="9" width="10" height="2" transform="rotate(-180 13.0002 9)" fill="white" />
                    <path d="M7.00024 3L7.00024 5.5L4.50024 8L7.00024 10.5V13L2.00024 8L7.00024 3Z" fill="white" />
                  </svg>
                </div>
              </div>
              {% if title == 1 %}
            <div class="display-none-active-title"
                   data-shrink="none"
                   data-type-shrink="suborder"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                {% for suborder_name in suborders_name %}
                  <div class="title-bill_w-80 fsz15 suborder-bg  ">
                    <h4>{{ suborder_name.name }}</h4>
                  </div>
                {% endfor %}
                <div class="title-bill_w-80 fsz15 suborder-bg "
                     data-shrink="none"
                     data-type-shrink="suborder"
                     data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                  <h4>Премии</h4>
                </div>
              </div> 
              {% else %}
              <div class="display-none-active-title"
              data-shrink="none"
                   data-type-shrink="suborder"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
              {% for name_sabs in suborders_name_no_adv  %}
              <div class="title-bill_w-80 fsz15 suborder-bg  ">
                <h4>{{name_sabs.other_id__name}}</h4>
              </div>
              {% endfor %}
            </div> 
              {% endif %}
             


              
            </div>
            <div class="suborder_entry-bg">
              <div class="title-bill-120 entry-bg mr40">
                <h3>Приход</h3>
                <div class="open-modal btn_month_bill-shrink"
                     data-name=""
                     data-month="0"
                     data-btn-deg-entry="180"
                     data-btn-type-shrink="entry"
                     data-created-btn="{{ bill.created_timestamp|date:'m.Y' }}"
                     data-cat-service="{{ title }}">
                  <svg width="16"
                       height="16"
                       viewBox="0 0 16 16"
                       fill="none"
                       xmlns="http://www.w3.org/2000/svg">
                    <rect x="16.0002" y="16" width="16" height="16" rx="8" transform="rotate(-180 16.0002 16)" fill="black" />
                    <rect x="13.0002" y="9" width="10" height="2" transform="rotate(-180 13.0002 9)" fill="white" />
                    <path d="M7.00024 3L7.00024 5.5L4.50024 8L7.00024 10.5V13L2.00024 8L7.00024 3Z" fill="white" />
                  </svg>
                </div>
              </div>
              <div class="title-bill_w-80 fsz15 entry-bg"
                   data-shrink="none"
                   data-type-shrink="entry"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>ООО</h4>
              </div>
              <div class="title-bill_w-80 fsz15 entry-bg"
                   data-shrink="none"
                   data-type-shrink="entry"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>ИП</h4>
              </div>
              <div class="title-bill_w-80 fsz15 entry-bg"
                   data-shrink="none"
                   data-type-shrink="entry"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>$</h4>
              </div>
            </div>
            <div class="suborder_out-bg ">
              <div class="title-bill-120 out-bg mr40">
                <h3>Расход</h3>
                <div class="open-modal btn_month_bill-shrink"
                     data-name=""
                     data-month="0"
                     data-btn-deg-out="180"
                     data-btn-type-shrink="out"
                     data-created-btn="{{ bill.created_timestamp|date:'m.Y' }}"
                     data-cat-service="{{ title }}">
                  <svg width="16"
                       height="16"
                       viewBox="0 0 16 16"
                       fill="none"
                       xmlns="http://www.w3.org/2000/svg">
                    <rect x="16.0002" y="16" width="16" height="16" rx="8" transform="rotate(-180 16.0002 16)" fill="black" />
                    <rect x="13.0002" y="9" width="10" height="2" transform="rotate(-180 13.0002 9)" fill="white" />
                    <path d="M7.00024 3L7.00024 5.5L4.50024 8L7.00024 10.5V13L2.00024 8L7.00024 3Z" fill="white" />
                  </svg>
                </div>
              </div>
              <div class="title-bill_w-80 fsz15 out-bg "
                   data-shrink="none"
                   data-type-shrink="out"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>ООО</h4>
              </div>
              <div class="title-bill_w-80 fsz15 out-bg "
                   data-shrink="none"
                   data-type-shrink="out"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>ИП</h4>
              </div>
              <div class="title-bill_w-80 fsz15 out-bg "
                   data-shrink="none"
                   data-type-shrink="out"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>$</h4>
              </div>
            </div>
          </div>
        {% endifchanged %}
        <div class="bill-month_item-wrapper {% if forloop.last %}last-loop{% endif %}">
          <div class="bill-month-client-del {% if forloop.last %}last-loop-btn-del{% endif %}">
            <button class=" btn_month_bill btn_month_bill-del "
                    data-name=""
                    data-id-bill="{{ bill.id }}"
                    data-month="0"
                    data-cat-service="{{ title }}">+</button>
          </div>
          <div class="bill-month-client-counter{% if forloop.last %} last-loop-btn {% endif %}">
            {% if forloop.counter < 10 %}0{% endif %}
            {{ forloop.counter }}.
          </div>
          <div class="bill-month-client-name bill_w-120">{{ bill.client.client_name }}</div>
          <div class="bill-month-client-contract bill_w-120">{{ bill.contract_number }}</div>
          <div class="bill-month-client-sum bill_w-120">{{ bill.contract_sum }} ₽</div>
          {% if title == 1 %}
          <div class="bill-month-client-adv_sum bill_w-120">{{ bill.adv_all_sum }} ₽</div>
          {% endif %}
          
          <div class="suborder_subs-oper-bg {% if forloop.last %}last-loop-bg{% endif %}">
          

            
            {% if title == 1 %}
            <div class="mr40 mr_p_oper bill-month-client-suborder_diff bill_w-120 add_sabcontactor {% if bill.chekin_add_subcontr == 0 %}red{% endif %}"
                 data-name="modal-add-subcontract"
                 data-bill-month-id="{{ bill.id }}"
                 data-bill-month-client-name="{{ bill.client.client_name }}"
                 data-bill-month-adv="{{ bill.diff_sum }}"
                 data-bill-month-name="{{ bill.contract_number }}"
                 data-bill-month-data="{{ created_timestamp|date:'F Y' }}"
                 data-bill-sb="{{ bill.subcontractmonth }}">{{ bill.diff_sum }} ₽
              </div>
              <div class="display-none-active-adv"
                   data-shrink="none"
                   data-type-shrink="suborder"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                {% for sub_adv in bill.suborders_adv %}
                  {% if bill.chekin_add_subcontr %}
                    {% if sub_adv.name_adv != 0 %}
                      {% if sub_adv.amount_subs != 0 %}
                        <div class="bill_w-80 mr_p_oper ">
                          <div class="suborder_out_operation fsz15 "
                               data-sub-type="1"
                               data-name="modal-suborder_out_operation"
                               data-bill-month-id="{{ bill.id }}"
                               data-bill-month-adv="{{ bill.diff_sum }}"
                               data-bill-month-client-name="{{ bill.client.client_name }}"
                               data-bill-month-name="{{ bill.contract_number }}"
                               data-bill-month-data="{{ created_timestamp|date:'F Y' }}"
                               data-name-sub=" {{ sub_adv.name_adv }}"
                               data-id-sub="{{ sub_adv.id_subs }}"
                               data-id-sub-amount="{{ sub_adv.amount_subs }}">{{ sub_adv.amount_subs }} ₽</div>
                        </div>
                      {% else %}
                        <div class="bill_w-80 fsz15 mr_p_oper">0 ₽</div>
                      {% endif %}
                    {% else %}
                    {% endif %}
                  {% else %}
                    <div class="bill_w-80 red fsz15 mr_p_oper">n/a</div>
                  {% endif %}
                {% endfor %}
              </div>
              <div class="display-none-active-other"
                   data-shrink="none"
                   data-type-shrink="suborder"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                {% for sub_other in bill.suborders_other %}
                  {% if sub_other.total_amount != 0 %}
                    {% if forloop.last %}
                      <div class="bill_w-80 fsz15 mr_p_oper">
                        <div class="suborder_out_operation_people"
                             data-sub-type="2"
                             data-name="modal-suborder_out_operation_people"
                             data-bill-month-id="{{ bill.id }}"
                             data-bill-month-adv="{{ bill.diff_sum }}"
                             data-bill-month-client-name="{{ bill.client.client_name }}"
                             data-bill-month-name="{{ bill.contract_number }}"
                             data-bill-month-data="{{ bill.created_timestamp|date:'F Y' }}"
                             data-name-sub="Премии"
                             data-id-sub=" {{ sub_other.id_subs }}"
                             data-id-sub-amount=" {{ sub_other.total_amount }} ">{{ sub_other.total_amount }}  ₽</div>
                      </div>
                    {% endif %}
                  {% else %}
                    <div class="mr_p_oper bill_w-80 fsz15 {% if bill.chekin_add_subcontr == 0 %}red{% endif %}">0 ₽</div>
                  {% endif %}
                {% empty %}
                {% endfor %}
              </div>
            {% else %}
       
            {% for other_tot in bill.suborders_other_no_adv %}
             
              {% if other_tot.total_amount >= 0 %}
              <div class="mr40 mr_p_oper bill-month-client-suborder_diff bill_w-120 add_sabcontactor "
                 data-name="modal-add-subcontract"
                 data-bill-month-id="{{ bill.id }}"
                 data-bill-month-client-name="{{ bill.client.client_name }}"
                 data-bill-month-adv="{{ bill.diff_sum }}"
                 data-bill-month-name="{{ bill.contract_number }}"
                 data-bill-month-data="{{ created_timestamp|date:'F Y' }}"
                 data-bill-sb="{{ bill.subcontractmonth }}">{{ other_tot.total_amount }} ₽
              </div> 
              {% else %}
              {% if other_tot.id_amount != 0 %}
              
              {% endif %}
              <div class="display-none-active-adv"
              data-shrink="none"
              data-type-shrink="suborder"
              data-created="{{ bill.created_timestamp|date:'m.Y' }}">
            {% for cat_other in suborders_name_no_adv %}
              {% if cat_other.other_id__name == other_tot.name %}
               <div  class="mr_p_oper bill_w-80 fsz15" data-sub-type="1"
               data-name="modal-suborder_out_operation"
               data-bill-month-id="{{ bill.id }}"
               data-bill-month-adv="{{ bill.diff_sum }}"
               data-bill-month-client-name="{{ bill.client.client_name }}"
               data-bill-month-name="{{ bill.contract_number }}"
               data-bill-month-data="{{ created_timestamp|date:'F Y' }}"
               data-name-sub=" {{ sub_adv.name_adv }}"
               data-id-sub="{{ sub_adv.id_subs }}"
               data-id-sub-amount="{{ sub_adv.amount_subs }}">{{other_tot.id_amount }} ₽</div> 
               {% else %}
              {% endif %}
              {% endfor %}
            </div> 
             {% endif %}
              
              
           {% comment %} <div class="mr_p_oper bill_w-80 fsz15">{{other_subs_other.id_amount}} ₽</div>   {% endcomment %}
            {% endfor %} 
              {% endif %}
          </div>
         
          {% for oper_entry in bill.get_operation %}
            {% ifchanged %}
              <div class="entry_subs-oper-bg {% if forloop.parentloop.last %}last-loop-bg-entry{% endif %}">
                <div class=" mr40 mr_p_oper bill-month-client-suborder_diff  add_sabcontactor add-operation-entry "
                     data-name="modal-add-operation-entry"
                     data-bill-month-id="{{ bill.id }}"
                     data-bill-month-sum="{{ bill.contract_sum }} "
                     data-bill-month-client-name="{{ bill.client.client_name }}"
                     data-bill-month-sum-dont-operation="{{ bill.contract_sum }} "
                     data-bill-month-name="{{ bill.contract_number }}"
                     data-bill-month-operation-entry=" {{ oper_entry.id_operation_entry }} ">
                  {% if oper_entry.operation_entry_all == bill.contract_sum %}
                    <p class="result_ok">{{ bill.contract_sum }} ₽</p>
                  {% elif oper_entry.diff_operation_entry > 0 %}
                    <div class="result_not-wrap">
                      <p class="result_not">
                        {{ oper_entry.operation_entry_all }}₽
                        <p class="result_not_after">/долг {{ oper_entry.diff_operation_entry }}₽</p>
                      </p>
                    </div>
                  {% else %}
                    <div class="result_not-wrap">
                      <p class="result_not">
                        0 ₽
                        <p class="result_not_after">/долг {{ bill.contract_sum }}₽</p>
                      </p>
                    </div>
                  {% endif %}
                </div>
                <div class="bill_w-80 mr_p_oper "
                     data-shrink="none"
                     data-type-shrink="entry"
                     data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                  <p class="operation_entry_bank_true fsz15">
                    {% if oper_entry.operation_entry_bank1 %}
                      {{ oper_entry.operation_entry_bank1 }}₽
                    {% else %}
                      0 ₽
                    {% endif %}
                  </p>
                </div>
                <div class="bill_w-80 mr_p_oper "
                     data-shrink="none"
                     data-type-shrink="entry"
                     data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                  <p class="operation_entry_bank_true fsz15">
                    {% if oper_entry.operation_entry_bank2 %}
                      {{ oper_entry.operation_entry_bank2 }}₽
                    {% else %}
                      0 ₽
                    {% endif %}
                  </p>
                </div>
                <div class="bill_w-80 mr_p_oper "
                     data-shrink="none"
                     data-type-shrink="entry"
                     data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                  <p class="operation_entry_bank_true fsz15">
                    {% if oper_entry.operation_entry_bank3 %}
                      {{ oper_entry.operation_entry_bank3 }}₽
                    {% else %}
                      0 ₽
                    {% endif %}
                  </p>
                </div>
              </div>
              <div class="out_subs-oper-bg {% if forloop.parentloop.last %}last-loop-bg-out{% endif %}">
                <div class=" mr40 mr_p_oper bill-month-client-suborder_diff  add_sabcontactor add-operation-entry ">
                  {% if oper_entry.operation_out_all == bill.diff_sum %}
                    <p class="result_ok">{{ bill.diff_sum }} ₽</p>
                  {% elif oper_entry.diff_operation_out > 0 %}
                    <div class="result_not-wrap">
                      <p class="result_not">
                        {{ oper_entry.operation_out_all }}₽
                        <p class="result_not_after">/остаток {{ oper_entry.diff_operation_out }}₽</p>
                      </p>
                    </div>
                  {% else %}
                    <div class="result_not-wrap">
                      <p class="result_not">
                        0 ₽
                        <p class="result_not_after">/остаток {{ bill.diff_sum }}₽</p>
                      </p>
                    </div>
                  {% endif %}
                </div>
                <div class="bill_w-80 mr_p_oper"
                     data-shrink="none"
                     data-type-shrink="out"
                     data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                  <p class="operation_entry_bank_true fsz15">
                    {% if bill.chekin_add_subcontr %}
                      {% if oper_entry.operation_out_bank1 %}
                        {{ oper_entry.operation_out_bank1 }}₽
                      {% else %}
                        0 ₽
                      {% endif %}
                    {% else %}
                      n/a
                    {% endif %}
                  </p>
                </div>
                <div class="bill_w-80 mr_p_oper"
                     data-shrink="none"
                     data-type-shrink="out"
                     data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                  <p class="operation_entry_bank_true fsz15">
                    {% if bill.chekin_add_subcontr %}
                      {% if oper_entry.operation_out_bank2 %}
                        {{ oper_entry.operation_out_bank2 }}₽
                      {% else %}
                        0 ₽
                      {% endif %}
                    {% else %}
                      n/a
                    {% endif %}
                  </p>
                </div>
                <div class="bill_w-80 mr_p_oper"
                     data-shrink="none"
                     data-type-shrink="out"
                     data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                  <p class="operation_entry_bank_true fsz15">
                    {% if bill.chekin_add_subcontr %}
                      {% if oper_entry.operation_out_bank3 %}
                        {{ oper_entry.operation_out_bank3 }}₽
                      {% else %}
                        0 ₽
                      {% endif %}
                    {% else %}
                      n/a
                    {% endif %}
                  </p>
                </div>
              </div>
            {% endifchanged %}
          {% endfor %}
        </div>
      </div>
      {% if forloop.last %}
        <div class="bill-month_category-result bill-month_category-ended">
          <div class="bill-month-del"></div>
          <div class="bill-month-client-counter"></div>
          <div class="bill_w-120-result">
            <h3>Итого</h3>
          </div>
          <div class="bill_w-120-result"></div>
          <div class="bill_w-120-result">
            <h3>{{ total_month_contract_sum }} ₽</h3>
          </div>
          {% if title == 1 %} 
          <div class="bill_w-120-result">
            <h3>{{ total_month_adv_all_sum }} ₽</h3>
          </div>
         
         
          <div class="suborder_title-bg-result">
            <div class="bill_w-120-result bill_w-120-result-upd">
              <h3>{{ total_month_diff_sum }} ₽</h3>
              <div class="elem16"></div>
            </div>
            <div class="display-none-active-title"
                 data-shrink="none"
                 data-type-shrink="suborder"
                 data-created="{{ bill.created_timestamp|date:'m.Y' }}">
              {% for total_adv in obj_suborder_adv %}
                <div class="title-bill_w-80-result fsz15 ">
                  <h4>{{ total_adv.total_amount }} ₽</h4>
                </div>
              {% endfor %}
              <div class="title-bill_w-80-result fsz15  "
                   data-shrink="none"
                   data-type-shrink="suborder"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>{{ suborder_total_other.total_amount }} ₽</h4>
              </div>
            </div>
          </div> 
          {% else %}
          
         
    
          <div class="suborder_title-bg-result">
            <div class="bill_w-120-result bill_w-120-result-upd">
              <h3>{{ suborder_total_other.total_amount  }} ₽</h3>
              <div class="elem16"></div>
            </div>
            <div class="display-none-active-title"
            data-shrink="none"
            data-type-shrink="suborder"
            data-created="{{ bill.created_timestamp|date:'m.Y' }}">
            {% for name_no_adv_tiotal in suborders_name_no_adv %}
            <div class="title-bill_w-80-result fsz15 ">
              <h4>{{ total_adv.total_amount }} ₽</h4>
            </div>
            {% endfor %}
          </div>


          </div> 
         
          {% endif %}
          {% for total_operat in total_oper %}
            <div class="suborder_entry-bg-result">
              {% if total_operat.total_diff_operation_entry == 0 %}
                <div class="bill_w-120-result-upd mr40">
                  <h3>{{ total_operat.total_sum_all_operation_entry }}  ₽</h3>
                </div>
              {% else %}
                <div class="title-bill-120  mr40 not_check">
                  <h3 class="result_not">
                    {{ total_operat.total_sum_all_operation_entry }} ₽
                    <p class="result_not_after">/долг {{ total_operat.total_diff_operation_entry }} ₽</p>
                  </h3>
                </div>
              {% endif %}
              <div class="title-bill_w-80-result fsz15 "
               data-shrink="none"
                   data-type-shrink="entry"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>{{ total_operat.total_sum_operation_entry_bank1 }}  ₽</h4>
              </div>
              <div class="title-bill_w-80-result fsz15 "
               data-shrink="none"
                   data-type-shrink="entry"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>{{ total_operat.total_sum_operation_entry_bank2 }}  ₽</h4>
              </div>
              <div class="title-bill_w-80-result fsz15 "
               data-shrink="none"
                   data-type-shrink="entry"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
                <h4>{{ total_operat.total_sum_operation_entry_bank3 }}  ₽</h4>
              </div>
            </div> 
            <div class="suborder_entry-bg-result">
          {% if total_operat.total_diff_operation_out == 0 %}
         
              <div class="bill_w-120-result-upd mr40">
                <h3>{{ total_operat.total_sum_all_operation_out }}  ₽</h3>
              </div>
            {% else %}
              <div class="title-bill-120  mr40 not_check">
                <h3 class="result_not">
                  {{ total_operat.total_sum_all_operation_out }} ₽
                  <p class="result_not_after">/остаток {{ total_operat.total_diff_operation_out }} ₽</p>
                </h3>
              </div>
            {% endif %} 
            <div class="title-bill_w-80-result fsz15 "
             data-shrink="none"
                   data-type-shrink="out"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
              <h4>{{ total_operat.total_sum_operation_out_bank1 }}  ₽</h4>
            </div>
            <div class="title-bill_w-80-result fsz15 "
             data-shrink="none"
                   data-type-shrink="out"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
              <h4>{{ total_operat.total_sum_operation_out_bank2 }}  ₽</h4>
            </div>
            <div class="title-bill_w-80-result fsz15 "
             data-shrink="none"
                   data-type-shrink="out"
                   data-created="{{ bill.created_timestamp|date:'m.Y' }}">
              <h4>{{ total_operat.total_sum_operation_out_bank3 }}  ₽</h4>
            </div> 
</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}
  </section>
{% endblock content %}
